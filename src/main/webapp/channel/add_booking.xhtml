<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns:ui="http://java.sun.com/jsf/facelets"
                template="/resources/template/template.xhtml"
                xmlns:p="http://primefaces.org/ui"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:ch="http://java.sun.com/jsf/composite/channel"
                xmlns:pa="http://java.sun.com/jsf/composite/paymentMethod"
                xmlns:au="http://java.sun.com/jsf/composite/autocomplete"
                xmlns:pat="http://java.sun.com/jsf/composite/patient"
                xmlns:ez="http://xmlns.jcp.org/jsf/composite/ezcomp">

    <ui:define name="content">
        <h:form id="form">

            <h:panelGroup rendered="#{not channelBillController.printPreview}">
                <p:panelGrid columns="2" >
                    <p:outputLabel value="Speciality" ></p:outputLabel>
                    <p:outputLabel value="#{bookingController.speciality.name}" ></p:outputLabel>
                    <p:outputLabel value="Consultant" ></p:outputLabel>
                    <p:outputLabel value="#{bookingController.staff.person.nameWithTitle}" ></p:outputLabel>
                    <p:outputLabel value="Session" ></p:outputLabel>
                    <p:outputLabel value="#{bookingController.selectedServiceSession.name}" ></p:outputLabel>
                    <p:outputLabel value="Date" ></p:outputLabel>
                    <p:outputLabel value="#{bookingController.selectedServiceSession.sessionDate}" >
                        <f:convertDateTime pattern="#{sessionController.applicationPreference.longDateFormat}" ></f:convertDateTime>
                    </p:outputLabel>
                    <p:outputLabel value="Time" ></p:outputLabel>
                    <p:outputLabel value="#{bookingController.selectedServiceSession.originatingSession.sessionTime}" >
                        <f:convertDateTime pattern="#{sessionController.applicationPreference.longTimeFormat}" ></f:convertDateTime>
                    </p:outputLabel>
                    <p:outputLabel value="Consultant Fee" ></p:outputLabel>
                    <p:outputLabel value="#{bookingController.selectedServiceSession.originatingSession.channelStaffFee}" >
                        <f:convertNumber pattern="#,##0.00" ></f:convertNumber>
                    </p:outputLabel>
                    <p:outputLabel value="Total" ></p:outputLabel>
                    <p:outputLabel value="#{bookingController.selectedServiceSession.originatingSession.totalFfee}" >
                        <f:convertNumber pattern="#,##0.00" ></f:convertNumber>
                    </p:outputLabel>
                </p:panelGrid>


                <h:panelGroup id="gdManageBookings" class="row p-1" style="height: 50vh;" layout="block">
                    <div class="col-md-2" >
                        <h:panelGrid id="pgNewBookingDetail" columns="2"  > 
                            <p:outputLabel value="Amount"/>

                            <h:panelGroup id="lblSessionTotal">
                                <p:outputLabel  
                                    value="#{bookingController.selectedServiceSession.originatingSession.totalFfee}"
                                    rendered="#{channelBillController.foriegn}">
                                    <f:convertNumber pattern="#,##0.00" ></f:convertNumber>
                                </p:outputLabel>
                                <p:outputLabel  
                                    value="#{bookingController.selectedServiceSession.originatingSession.totalFee}"
                                    rendered="#{!channelBillController.foriegn}">
                                    <f:convertNumber pattern="#,##0.00" ></f:convertNumber>
                                </p:outputLabel>

                            </h:panelGroup>

                            <p:outputLabel value="Payment Method"/>
                            <h:panelGroup >
                                <p:selectOneMenu  id="cmbPs" value="#{channelBillController.paymentMethod}">  
                                    <f:selectItem itemLabel="Select Payment Method" ></f:selectItem>
                                    <f:selectItems value="#{enumController.paymentMethodsForChannel}"/>                                                               
                                    <f:ajax execute="@this" render="agent agent2 ballance ballance2 agRefLbl agRefTxt creditCardSlc creditCardbnkLbl 
                                            creditCardTxt creditCardRef slipLblBank slipSelBank slipLblDate date staff autoStaff lblCheque chequNo lblBank 
                                            lblChequeDate ChequeDate bankSel :#{p:resolveFirstComponentWithId('lblSessionTotal',view).clientId} :#{p:resolveFirstComponentWithId('acSessions',view).clientId}" event="change" listener="#{bookingController.generateSessions}" />
                                </p:selectOneMenu>
                                <h:outputScript>
                                    $(document.getElementById('form:cmbPs_focus')).keypress(function (event) {
                                    var keycode = (event.keyCode ? event.keyCode : event.which);
                                    alert("sdf");
                                    if (keycode == '13') {
                                    document.getElementById("form:txtSearch3").focus();
                                    return false;
                                    }

                                    });
                                </h:outputScript>
                            </h:panelGroup>
                            <p:outputLabel value="Discount Scheme"/>
                            <p:selectOneMenu   id="cmbPs2" value="#{channelBillController.paymentScheme}">     
                                <f:selectItem itemLabel="Select Discount Scheme"/>
                                <f:selectItems value="#{paymentSchemeController.paymentSchemesForChannel}" 
                                               var="paysch" itemLabel="#{paysch.name}" itemValue="#{paysch}"  />
                                <p:ajax process="@this" 
                                        update="lblSessionTotal" 
                                        event="change" 
                                        listener="#{channelBillController.changeListener()}"/>
                            </p:selectOneMenu>

                            <h:outputLabel/>
                            <p:selectBooleanCheckbox id="f" value="#{channelBillController.foriegn}" itemLabel="Foriegner">
                                <f:ajax event="change" execute="@this acSessions" render="lblSessionTotal"/>
                            </p:selectBooleanCheckbox>
                            <h:outputLabel id="agent" value="Agent"  style="display: #{channelBillController.paymentMethod eq 'Agent' ? 'block' : 'none'} ; " />
                            <p:autoComplete id="agent2" forceSelection="true" style="display: #{channelBillController.paymentMethod eq 'Agent'? 'block' : 'none'} ; "
                                            value="#{channelBillController.institution}"  completeMethod="#{agencyController.completeAgency}" var="ix"
                                            itemLabel="#{ix.name}" itemValue="#{ix}" styleClass="mediuminput" >
                                <f:ajax  event="itemSelect" execute="@this"  render="ballance ballance2 lblSessionTotal agRefLbl agRefTxt :#{p:resolveFirstComponentWithId('agRefLbl',view).clientId} :#{p:resolveFirstComponentWithId('tblAgentBooks',view).clientId} pgNewBookingDetail" listener="#{channelBillController.validateAgentBalance()}"/>
                                <!--<p:ajax event="click" process="@this" update=":#{p:resolveFirstComponentWithId('agRefLbl',view).clientId} :#{p:resolveFirstComponentWithId('tblAgentBooks',view).clientId} pgNewBookingDetail" />-->
                                <p:column>#{ix.institutionCode}</p:column>
                                <p:column>#{ix.name}</p:column>                                
                            </p:autoComplete> 

                            <h:outputLabel id="agRefLbl" value="Agent Ref"  style="display: #{channelBillController.paymentMethod eq 'Agent'? 'block' : 'none'} ; "/>
                            <p:inputText autocomplete="off" id="agRefTxt" value="#{channelBillController.agentRefNo}"  style="display: #{channelBillController.paymentMethod eq 'Agent' ? 'block' : 'none'} ; " />
                            <p:tooltip for="agRefLbl agent" >
                                <p:dataTable id="tblAgentBooks" value="#{channelBillController.institution.agentReferenceBooks}" var="a">
                                    <p:column>
                                        <f:facet name="header">
                                            <p:outputLabel value="S.R.N." />
                                        </f:facet>
                                        <p:outputLabel value="#{a.startingReferenceNumber}" >
                                            <f:convertNumber pattern="00000" />
                                        </p:outputLabel>
                                    </p:column>
                                    <p:column>
                                        <f:facet name="header">
                                            <p:outputLabel value="E.R.N." />
                                        </f:facet>
                                        <p:outputLabel value="#{a.endingReferenceNumber}" >
                                            <f:convertNumber pattern="00000" />
                                        </p:outputLabel>
                                    </p:column>
                                </p:dataTable>
                            </p:tooltip>
                            <p:outputLabel />

                            <h:outputLabel id="ballance" value="Ballance"  style="display: #{channelBillController.paymentMethod eq 'Agent' ? 'block' : 'none'} ; " />
                            <h:outputLabel id="ballance2" value="#{channelBillController.institution.ballance}"  style="display: #{channelBillController.paymentMethod eq 'Agent' ? 'block' : 'none'} ; " />

                            <h:outputLabel id="staff" value="Staff"  style="display: #{channelBillController.paymentMethod eq 'Staff' ? 'block' : 'none'} ; " />
                            <h:panelGroup id="autoStaff" style="display: #{channelBillController.paymentMethod eq 'Staff' ? 'block' : 'none'} ; ">
                                <au:completeStaffChannel value="#{channelBillController.toStaff}" />
                            </h:panelGroup>

                            <h:outputLabel id="creditCardRef" value="Card Ref. No." style="display: #{channelBillController.paymentMethod ne 'Card' ? 'none' : 'block'} ;"/>
                            <p:inputText id="creditCardTxt" autocomplete="off"   value="#{channelBillController.paymentMethodData.creditCard.no}" style="display: #{channelBillController.paymentMethod ne 'Card' ? 'none' : 'block'} ;"/>
                            <h:outputLabel id="creditCardbnkLbl" value="Select Bank" style="display: #{channelBillController.paymentMethod ne 'Card' ? 'none' : 'block'} ;"/>
                            <p:selectOneMenu id="creditCardSlc" value="#{channelBillController.paymentMethodData.creditCard.institution}" style="display: #{channelBillController.paymentMethod ne 'Card' ? 'none' : 'block'} ;">
                                <f:selectItem itemLabel="Select Bank"/>
                                <f:selectItems value="#{institutionController.banks}" var="inst" itemLabel="#{inst.name}" itemValue="#{inst}"/>
                            </p:selectOneMenu>




                            <h:outputLabel id="lblCheque" value="Cheque No." style="display: #{channelBillController.paymentMethod ne 'Cheque' ? 'none' : 'block'} ; "/>
                            <p:inputText autocomplete="off"  value="#{channelBillController.paymentMethodData.cheque.no}" id="chequNo" style="display: #{channelBillController.paymentMethod ne 'Cheque' ? 'none' : 'block'} ; " />
                            <h:outputLabel id="lblBank" value="Select Bank" style="display: #{channelBillController.paymentMethod ne 'Cheque' ? 'none' : 'block'} ; "/>
                            <p:selectOneMenu  id="bankSel" value="#{channelBillController.paymentMethodData.cheque.institution}" style="display: #{channelBillController.paymentMethod ne 'Cheque' ? 'none' : 'block'} ; " >
                                <f:selectItem itemLabel="Select Bank"/>
                                <f:selectItems value="#{institutionController.banks}" var="inst" itemLabel="#{inst.name}" itemValue="#{inst}"/>
                            </p:selectOneMenu>
                <!--            <p:inputText autocomplete="off"   value="#{channelBillController.paymentMethodData.creditCard.comment}"  id="memo"/>-->

                            <h:outputLabel id="lblChequeDate" value="Cheque Date" style="display: #{channelBillController.paymentMethod ne 'Cheque' ? 'none' : 'block'} ; "/>
                            <p:calendar   value="#{channelBillController.paymentMethodData.cheque.date}" pattern="dd MMMM yyyy" id="ChequeDate" style="display: #{channelBillController.paymentMethod ne 'Cheque' ? 'none' : 'block'} ; " >                            
                            </p:calendar>




                            <h:outputLabel value="Select Bank" id="slipLblBank" style="display: #{channelBillController.paymentMethod ne 'Slip' ? 'none' : 'block'} ;"/>
                            <p:selectOneMenu id="slipSelBank" value="#{channelBillController.paymentMethodData.slip.institution}" style="display: #{channelBillController.paymentMethod ne 'Slip' ? 'none' : 'block'} ;">
                                <f:selectItem itemLabel="Select Bank"/>
                                <f:selectItems value="#{institutionController.banks}" var="inst" itemLabel="#{inst.name}" itemValue="#{inst}"/>
                            </p:selectOneMenu>
                            <h:outputLabel value="Slip Date" id="slipLblDate" style="display: #{channelBillController.paymentMethod ne 'Slip' ? 'none' : 'block'} ;"/>
                            <p:calendar  value="#{channelBillController.paymentMethodData.slip.date}" pattern="dd MMMM yyyy" id="date" style="display: #{channelBillController.paymentMethod ne 'Slip' ? 'none' : 'block'} ;">                            
                            </p:calendar>


                        </h:panelGrid>  
                    </div>
                    <div class="col-md-4" >
                        <p:panel id="gpThisBookingDetails" style="min-width: 500px; max-width: 500px; min-height:400px;max-height: 400px;"  >
                            <f:facet name="header" >

                            </f:facet>
                            <p:tabView id="tabViewPatientDetails" activeIndex="#{channelBillController.patientSearchTab}" >
                                <p:ajax event="tabChange"  process="@this" listener="#{channelBillController.onTabChange}" />

                                <p:tab id="tabNewPt" title="New Pateint">
                                    <h:panelGrid columns="2">
                                        <h:outputLabel value="Title"/>
                                        <p:selectOneMenu id="somNewPtTitle" value="#{channelBillController.newPatient.person.title}"  >
                                            <f:selectItem itemLabel="Select Title"/>
                                            <f:selectItems value="#{billController.title}"/>
                                        </p:selectOneMenu>
                                        <h:outputLabel value="Name"/>
                                        <p:inputText autocomplete="off"  id="txtNewPtName" value="#{channelBillController.newPatient.person.name}" style="width: 200px;text-transform:uppercase;">
                                        </p:inputText>

                                        <h:outputLabel value="Phone"/>
                                        <p:inputText  id="txtNewPtPhone" autocomplete="off" maxlength="11" value="#{channelBillController.newPatient.person.phone}">
                                        </p:inputText>
                                        <h:outputLabel value="Sex"/>
                                        <p:selectOneMenu id="txtNewSex"  value="#{channelBillController.newPatient.person.sex}" style="width: 200px;">
                                            <f:selectItem itemLabel="Select Sex"/>
                                            <f:selectItems value="#{billController.sex}"/>
                                        </p:selectOneMenu> 
                                        <p:outputLabel value="Area"></p:outputLabel>
                                        <p:autoComplete styleClass="mediuminput" widgetVar="np" id="acnp" forceSelection="true" 
                                                        value="#{channelBillController.area}" 
                                                        completeMethod="#{areaController.completeArea}" 
                                                        var="npt" itemLabel="#{npt.name}" 
                                                        itemValue="#{npt}" size="30"  style="width: 40px;">
                                        </p:autoComplete>
                                    </h:panelGrid>
                                </p:tab>
                                <p:tab  id="tabSearchPt" title="Search Pateint">




                                    <p:autoComplete widgetVar="aPt" id="acPt" forceSelection="true" 
                                                    value="#{channelBillController.searchPatient}" 
                                                    completeMethod="#{patientController.completePatientByNameOrCodeOrTitle}" 
                                                    var="apt" itemLabel="#{apt.person.name}" maxResults="7" minQueryLength="4"
                                                    itemValue="#{apt}" size="30"  styleClass="mediuminput">

                                        <p:column headerText="Name">
                                            <h:outputLabel value="#{apt.person.nameWithTitle}" />
                                        </p:column>

                                        <p:column headerText="Age">
                                            <h:outputLabel value="#{apt.age}" />
                                        </p:column>
                                        <p:column headerText="Code">
                                            <h:outputLabel value="#{apt.code}" />
                                        </p:column>
                                        <p:column headerText="Sex">
                                            <h:outputLabel value="#{apt.person.sex}" />
                                        </p:column>
                                        <p:column headerText="Address">
                                            <h:outputLabel value="#{apt.person.address}" />
                                        </p:column>
                                        <p:column headerText="Phone No">
                                            <h:outputLabel value="#{apt.person.mobile}" />
                                            <h:outputLabel value="#{apt.person.phone}" />
                                        </p:column>
                                        <p:column headerText="Date of Birth">
                                            <h:outputLabel value="#{apt.person.dob}" >
                                                <f:convertDateTime pattern="dd MMMM yyyy"/>
                                            </h:outputLabel>
                                        </p:column>
                                        <p:column headerText="Membership">
                                            <h:outputLabel value="#{apt.person.membershipScheme.name}" >
                                            </h:outputLabel>
                                        </p:column>
                                        <p:ajax event="itemSelect" process="@this" update="panSearch"/>
                                    </p:autoComplete >
                                    <h:panelGroup  id="panSearch" >
                                        <pat:searchPatientDetail patient="#{channelBillController.searchPatient}"  />
                                    </h:panelGroup>

                                </p:tab>
                            </p:tabView>
                            <h:panelGrid columns="3" style="min-width: 100%;">
                                <p:commandButton   
                                    id="btnAdd" 
                                    value="Add"
                                    ajax="false"
                                    update="gpThisBookingDetails"
                                    class="m-1" 
                                    action="#{channelBillController.add}" >   
                                </p:commandButton>
                                <p:commandButton  
                                    action="#{channelBillController.startNewChannelBooking}" 
                                    value="New Booking" 
                                    ajax="false"/>
                            </h:panelGrid>

                        </p:panel>
                    </div>

                </h:panelGroup>
            </h:panelGroup>



            <h:panelGroup  rendered="#{channelBillController.printPreview}">
                <p:commandButton value="New Bill" action="#{channelBillController.makeNull()}" ajax="false"
                                 ></p:commandButton>

                <p:commandButton value="Back" action="#" ajax="false" oncomplete="PF('dlgAdd').hide();"
                                 rendered="#{!channelBillController.settleSucessFully}" 
                                 ></p:commandButton>

                <p:commandButton value="Print" ajax="false" action="#"
                                 disabled="#{channelBillController.printingBill.balance ne 0.0 or !channelBillController.settleSucessFully}">
                    <p:printer target="panelAddedBillPrint" ></p:printer>
                </p:commandButton>

                <h:panelGroup id="panelAddedBillPrint" styleClass="noBorder"
                              rendered="#{channelBillController.settleSucessFully}" >
                    <div >
                        <ez:bmsChannelBill bill="#{channelBillController.printingBill}"/>
                    </div>
                </h:panelGroup>

                <h:panelGroup  styleClass="noBorder" rendered="#{!channelBillController.settleSucessFully}" >
                    <br/>
                    <br/>
                    <p:outputLabel value="#{channelBillController.errorText}" style="color:#ff0000; font-size: xx-large;" /> 
                </h:panelGroup>
            </h:panelGroup>

        </h:form>
    </ui:define>
</ui:composition>